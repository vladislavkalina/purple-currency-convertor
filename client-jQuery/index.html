<!DOCTYPE html>
<html>

<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <script>
        window.onload = () => {
            loadCurrencyCodeList();
            loadStatistics();
        }

        //TODO: In case the frontend remain as it is (plain HTLM+jQuery), the following code will go to a separate file, e.g. frontend.js
        function loadCurrencyCodeList() {
            $.get("/api/currencyCodes", (response) => {
                if (response.error !== undefined) {
                    console.log("loadCurrencyCodeList response", response);
                    alert(`We're sorry, our server didn't feel good while providing the list of currency codes. Please contact technical support. Code: ${response.error}`);
                    return;
                };
                $('#sourceCurrency').html('');
                $('#destinationCurrency').html('');
                response.currencyCodes.forEach((element) => {
                    $('#sourceCurrency').append(`<option>${element}</option>`);
                    $('#destinationCurrency').append(`<option>${element}</option>`);
                })
            }).fail(function () {
                alert("We're sorry, communication with our server failed (currency codes).");
            });
        }

        function loadStatistics(delayIfNoLuck = 100) {
            $.get("/api/statistics", (response) => {
                renderStatistics(response, delayIfNoLuck)
            }).fail(function () {
                alert("We're sorry, communication with our server failed (statistics).");
            });
        }

        function renderStatistics(data, delayIfNoLuck = 100) {
            if (data.mostPopularCurrencies === undefined || data.totalAmountConverted === undefined || data.numberOfRequestsMade === undefined) {
                console.log("statistics not valid, next try in", delayIfNoLuck, data);
                setTimeout(() => { loadStatistics(2 * delayIfNoLuck) }, delayIfNoLuck);
                return;
            }
            $('#mostPopularCurrency').html(data.mostPopularCurrencies);
            $('#totalAmountConverted').html(data.totalAmountConverted);
            $('#numberOfConversionRequests').html(data.numberOfRequestsMade);
        }

        function convert() {
            const amount = parseFloat($('#sourceAmount').val());
            const srcCurrency = $('#sourceCurrency').val();
            const destCurrency = $('#destinationCurrency').val();
            if (srcCurrency === destCurrency) {
                alert("We are sorry, source and destination currency can't be equal.");
                return;
            }
            $.post(`/api/convert?amount=${amount}&src=${srcCurrency}&dst=${destCurrency}`, (response) => {
                if (response.error !== undefined) {
                    console.error(response);
                    alert(`Backend part of application doesn't work properly.\nPlease contact technical support. Code: ${response.error}`);
                    return;
                }
                $('#results').append("<div>" + amount + " " + $('#sourceCurrency').val()
                    + " is " + response.destinationAmount + " " + $('#destinationCurrency').val() + "</div>");
                renderStatistics(response.statistics);
            }).fail(function () {
                alert("We're sorry, communication with our server failed (convert).");
            });
        }
    </script>
    <style>
        /*TODO: In case the frontend remain as it is (plain HTLM+jQuery), the following code will go to a separate file, e.g. frontend.js*/
        span.statItem {
            display: inline-block;
            width: 300px
        }
    </style>
</head>

<body>
    <h1>Currency convertor</h1>

    <input id="sourceAmount" type="number" valueAsNumber value="0">
    <select id="sourceCurrency">
        <option>[loading...]</option>
    </select>
    to
    <select id="destinationCurrency">
        <option>[loading...]</option>
    </select>
    <button onclick="convert()">Convert!</button>

    <div id="results">
        <h2>Results:</h2>
    </div>

    <div id="statistics">
        <h2>Statistics:</h2>
        <div><span class="statItem">Most popular destination currency:</span>
            <span id="mostPopularCurrency">[loading...]</span>
        </div>
        <div><span class="statItem">Total amount converted:</span>
            <span id="totalAmountConverted">[loading...]</span> USD
        </div>
        <div><span class="statItem">Total number of conversion requests made:</span>
            <span id="numberOfConversionRequests">[loading...]</span>
        </div>
    </div>
</body>

</html>